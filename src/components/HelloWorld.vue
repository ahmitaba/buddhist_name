<template>
  <div class="hello">
    <h2>
      <a @click="step = 0">
        <img src="../assets/fuo.jpg" class="avatar" alt="fuo"/>
          å—ç„¡é˜¿å½Œé™€ä½›è¦ºé†’åœ˜éšŠ&nbsp;&nbsp;&nbsp;&nbsp;<br class="thin-only"/>
          <div style="width: 1em; height: 1em; display: inline-block;" class="thin-only"></div>æ˜å³°ä½›å¯ºå¿µä½›å…±ä¿®
        </a>
      </h2>

   <!--<h2 v-show="step == 0">Appå…è²»ä¸‹è¼‰</h2> -->



      <!-- 
        Use Google Formï¼ˆGoogleï¼‰    -->

     <!-- <div class="ui buttons" v-show="step == 0">
      <a class="ui huge blue button" href="https://apps.apple.com/tw/app/%E5%BF%B5%E4%BD%9B%E8%99%9F/id1637378153" target="_blank"><i class="app store icon" />App Storeä¸‹è¼‰
      </a>

      <a class="ui huge orange button" href="https://play.google.com/store/apps/details?id=tw.bestian.fuo" target="_blank"><i class="google play icon" />Google Playä¸‹è¼‰
      </a> 
    </div>-->

    <div class="ui divider" v-show="step == 0"></div>

    <a @click="step = 1" v-show="step == 0">
      <img class = "fuo" src="../assets/fuo.jpg" />
    </a>
    <br v-show="step == 0" />
    <div class="ui buttons up" v-show="step == 0">
      <a class="ui huge teal button" @click="step = 1"><i class="globe icon" />ç¶²ç«™ç‰ˆ
      </a>
    </div>


    <div class="ui segment container" v-show="step == 1">

      <h4 class="ui header">ä¸€å„„ä½›è™Ÿæ´»å‹•(2025/02/22~2025/09/28)</h4>

      <div class="ui active inverted dimmer" v-show="myTotal === undefined">
        <div class="ui text loader">è³‡æ–™è¼‰å…¥ä¸­...</div>
      </div>

      <div v-show="myTotal !== null" class="ui indicating green progress" :data-value="myTotal" data-total="10000000" id="ex">
        <div class="bar" :style="{width: (Math.min(myS, 100)) + '%'}">
          <div class="progress"></div>
        </div>
        <div class="label">å·²é”æˆï¼š{{ myTotal }} / 10000000</div>
      </div>

      <div class="label">
        <span v-show="myToDay">æœ¬æ—¥åŠ ç¸½ï¼š<b>{{ myToDay }}</b>è²ä½›è™Ÿ</span>
        <router-link to="/recent_count" class="ui tiny button" style="margin-left: 10px; font-size: 14px;">
          <i class="chart line icon"></i>æŸ¥çœ‹è¿‘æœŸçµ±è¨ˆ
        </router-link>
      </div>

      <div class="ui divider"></div>

      <div>
        <h3 class ="ui header">å—ç„¡é˜¿å½Œé™€ä½› å…­å­—æ´ªåå¤ªä¸å¯æ€è­° ğŸŸ¢ğŸ”µ<span class="fat-only">ğŸŸ¢ğŸ”µ</span></h3>
        <div class="buddha-blessing">
          <div style="margin-bottom: 0.5em;">
            è¥¿æ–¹æ¥µæ¨‚ä¸–ç•Œé€²å…¥çš„é€šé—œå¯†ç¢¼ ğŸ’šğŸ©·ğŸ’šğŸ©·ğŸ’š
          </div>
          <ul style="margin-left: 1.2em;" class="vertical-list">
            <li>
              <span style="font-weight: bold;">ğŸŒ ä¿¡ï¼š</span>30% å®Œå…¨ç›¸ä¿¡äººé¡ä¸æœƒç”Ÿç—…ä¸æœƒæ­»äº¡ã€‚
            </li>
            <li>
              <span style="font-weight: bold;">ğŸŒ é¡˜ï¼š</span>30% ä¸€å¿ƒä¸€æ„çš„é€éé€šé—œå¯†ç¢¼<br/><b style="margin-left: 1.2em;">ã€Œå—ç„¡é˜¿å½Œé™€ä½›ã€</b>å…­å­—å¤§æ³•å¥½ã€‚
            </li>
            <li>
              <span style="font-weight: bold;">ğŸŒ è¡Œï¼š</span>40% ç©æ¥µç„¡ç§ã€ç„¡æ€¨ç„¡æ‚”åœ°å¹«åŠ©çœ¾ç”Ÿ<br/><span style="margin-left: 1.2em;">å‰µé€ å¯¦ç›¸ä¸–ç•Œï¼</span>
            </li>
          </ul>
        </div>
      </div>


      <!-- <h4 class="ui header">
        2023 æ°¸æ˜ä½›å¯ºè¡Œè…³è¡Œç¨‹è¡¨
      <br/>
        <a href="https://docs.google.com/spreadsheets/d/19pJLqZK6HpKzg1W9rxkezJ2_g4BM5-FspMF3qZaLPQI/edit?usp=sharing" target="_blank" rel="noopener noreferrer">
        è¡Œç¨‹è¡¨è«‹æŒ‰æ­¤</a>
      </h4> -->

      <!--<h4 class="ui header">
        æ°¸æ˜ä½›å¯º+æ˜å³°ä½›å¯ºé»äº®å¿ƒç‡ˆå…‰æ˜ç‡ˆè¿´å‘è¡¨ï¼š
      <br/>
        <a href="https://forms.gle/zeuANUaxF5AWhrBH" target="_blank" rel="noopener noreferrer">https://forms.gle/zeuANUaxF5AWhrBH</a>
      <br/>
        æ°¸æ˜ä½›å¯º+æ˜å³°ä½›å¯ºç‚ºæ‚¨å®ˆè­·ä¸€è¼©å­å…‰æ˜å¿ƒç‡ˆ
      </h4>-->

      <div v-show="!dismiss">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScBmqo2vukf9_0566w9c-ASXfov5mfqGwmZdUEx-RHiBd6SAw/viewform?embedded=true" width="88%" height="676" frameborder="0" marginheight="0" marginwidth="0">è¼‰å…¥ä¸­â€¦</iframe>

        <h3 class ="ui header"> ä½¿ç”¨èªªæ˜</h3>
        <p>ç™½æ·¨å®¶äººä½›å®‰<br/>ç‚ºä¸–ç•Œåƒè¬å’Œå¹³ç¥ˆç¦ï¼é›†çµäººå€‘å–„å¿µå…±æŒ¯å­˜å„²ç„¡å½¢å¯Œè²´è²¡å¯Œï¼</p>
        <p>è«‹åœ¨ç¶²ç«™ä¸Šç™»éŒ„æ‚¨çš„åå­—å’Œä»Šå¤©å¿µäº†å¹¾è²ä½›è™Ÿï¼Œå†æŒ‰ã€Œç™»éŒ„ä½›è™Ÿã€æŒ‰éˆ•å³å¯ã€‚</p>
        
        <p>æ¯å€‹åå­—æ¯å¤©åªèƒ½ç™»éŒ„ä¸€æ¬¡ï¼Œè«‹åœ¨æ™šä¸Š7:30å‰ç™»éŒ„ä»¥ä¾¿å›å‘ï¼Œæ°¸æ˜ä½›å¯º+æ˜å³°ä½›å¯ºæœƒåœ¨æ™šä¸Š7:30-8:00é–“å›å‘ã€‚</p>

        <p>æ°¸æ˜ä½›å¯ºåœ°å€ï¼šå°æ±ç¸£å¤ªéº»é‡Œé„‰è¯æºæ‘å—åŒ—å‘58-1è™Ÿã€‚æ°¸æ˜ä½›å¯º+æ˜å³°ä½›å¯ºé›»è©±ï¼š<a herf="tel:0937280910">0937280910</a>ã€<a herf="tel:0982029814">0982029814</a></p>

        <p>æ˜å³°ä½›å¯ºåœ°å€ï¼šå°æ±ç¸£å‘å—é„‰æ˜å³°æ‘é¾éè„ˆ171ä¹‹ä¸€è™Ÿ</p>

        <p>ç›®å‰æœ‰<router-link class = "item" to ="/about"><i class ="plus icon"/>
          <span class="fat-only">åŠ ç¸½</span></router-link>çš„åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥è¼¸å…¥é—œéµå­—æ‰“è‡ªå·±çš„åå­—ï¼ŒæŸ¥åˆ°æ‰€æœ‰çš„è¨˜éŒ„å’ŒåŠ ç¸½ã€‚</p>

        <p>è‹¥æ‚¨å¸Œæœ›åœ¨å…¶ä»–ä½›å¯ºä½¿ç”¨é¡ä¼¼çš„è»Ÿé«”ï¼Œ<br/>å¯ä»¥åœ¨<i class = "github icon"/>Githubä¸Šï¼Œå°‡æœ¬å°ˆæ¡ˆå‰µå»ºåˆ†å‰ç‰ˆ(Fork)ï¼Œè‡ªè¡Œä¿®æ”¹æ¶ç«™ã€‚</p>
        <p>åŸå§‹ç¢¼å®Œå…¨å…¬é–‹ï¼Œè«‹è¦‹æ­¤ï¼š<a href="https://github.com/ahmitaba/buddhist_name" target="_blank"><i class = "github icon"/>åŸå§‹ç¢¼</a>

        &nbsp;&nbsp;&nbsp;&nbsp;<a class="ui red basic button" @click="dismiss = true">ä¸å†é¡¯ç¤ºæç¤º</a></p>
      </div>
    </div>

    <form class="ui form container" v-show="step == 1">
      <div class="fields">
        <div class="field">
          <label><i class = "calendar icon"/>ä»Šå¤©æ—¥æœŸï¼š{{date}}</label>
        </div>
        <div class="field">

          <label><i class = "user icon"/>æ‚¨çš„å§“å/æ³•åï¼š
          <input type="text" name="" v-model = "name"/> </label> 
        
        </div>
        <div class="field">
          <label><i class = "comment icon"/>æ‚¨ä»Šå¤©å¿µäº†å¹¾è²ä½›è™Ÿï¼š</label>
          <input type="number" v-model = "number" />
        </div>
        <div class="field">
          <label><i class = "question icon"/>å¿µä½›è™ŸåŸå› ï¼š</label>
          <input type="text" v-model = "reason" />
        </div>

        <!-- <div class="field left aligned">
          <input type="checkbox" v-model = "notJoin" />
          <label>ä¸åŠ å…¥åƒè¬ä½›è™Ÿçµ±è¨ˆè«‹å‹¾æ­¤</label>
        </div> -->
      </div>

      <div class="field">
        <div class="ui buttons">
          <button type="button" class="ui huge green button ani tada" @click.prevent="addNumber"><i class = "upload icon"/>ç™»éŒ„ä½›è™Ÿ</button>
          <!--<div class="or"></div>
          <button  type="button" class = "ui huge orange button ani tada" @click.prevent ="loginGoogle" v-if="!user"><i class = "google  icon"/>googleç™»å…¥</button> -->
          <!--<button  type="button" class = "ui huge blue button ani tada" @click.prevent ="logout" v-else>
            <img id = "r" :src="photoURL" />
            <i class = "sign-out icon"/>ç™»å‡º</button>-->
        </div>
      </div>
    </form>

    <div class="ui divider" v-show="step == 1"></div>

    <select id="s" class="ui dropdown" v-model="mode" v-show="step == 1">
      <option value="">æ¨¡å¼</option>
      <option value="today">ä»Šæ—¥</option>
      <option value="all">æ‰€æœ‰</option>
    </select>

    <div class="ui list container left aligned" v-show="mode == 'today' && step == 1">
      <div class="item" v-for = "(n, k) in t(s(names))" :key="k"> <img class="avatar" :src="par(n.photoURL)" v-show="n.photoURL" :alt="n.n"/> {{n.date}}: {{n.n}}å¿µäº†<span class="highlight"> {{parseInt(n.number)}} è²</span>ä½›è™Ÿ!! </div>
    </div>

    <div id="infinite" class="ui list container left aligned" v-show="mode == 'all' && step == 1">
      <div class="item" v-for = "(n, j) in s(allnames).slice(0, len)" :key="j"> <img class="avatar" :src="par(n.photoURL)" v-show="n.photoURL" :alt="n.n"/> {{n.date}}: {{n.n}}å¿µäº†<span class="highlight"> {{parseInt(n.number)}} è²</span>ä½›è™Ÿ!! </div>
    </div>

    <div class="ui divider" v-show="step == 1"></div>
    
    <form class="ui form container" v-show="names[0] && step == 1">
      <div class="fields">
        <div class="field">
          <label><i class = "calendar icon"/>ä»Šå¤©æ—¥æœŸï¼š{{date}}</label>
        </div>
        <div class="field">

          <label><i class = "user icon"/>æ‚¨çš„å§“å/æ³•åï¼š
          <input type="text" name="" v-model = "name"/> </label> 
        
        </div>
        <div class="field">
          <label><i class = "comment icon"/>æ‚¨ä»Šå¤©å¿µäº†å¹¾è²ä½›è™Ÿï¼š</label>
          <input type="number" v-model = "number" />
        </div>
        <div class="field">
          <label><i class = "question icon"/>æ‚¨å¿µä½›è™Ÿçš„åŸå› ï¼š</label>
          <input type="text" v-model = "reason" />
        </div>
      </div>

      <!-- <div class="field left aligned">
        <input type="checkbox" v-model = "notJoin" />
        <label>ä¸åŠ å…¥åƒè¬ä½›è™Ÿçµ±è¨ˆè«‹å‹¾æ­¤</label>
      </div> -->

      <div class="field">
        <div class="ui buttons">
          <button type="button" class="ui huge green button ani tada" @click.prevent="addNumber"><i class = "upload icon"/>ç™»éŒ„ä½›è™Ÿ</button>
          <!-- <div class="or"></div>
          <button type="button" class = "ui huge orange button ani tada" @click.prevent ="loginGoogle" v-if="!user"><i class = "google icon"/>googleç™»å…¥</button> -->
          <!--<button type="button" class = "ui huge blue button ani tada" @click.prevent ="logout" v-else>
            <img id = "r" :src="photoURL" />
            <i class = "sign-out icon"/>ç™»å‡º</button> -->
        </div>
      </div>
    </form>
    <div id = "container" style="disply:none">
      <!-- <a id ="downloadAnchorElem"></a>
      <a id ="downloadAnchorElem1"></a> -->
    </div>

  </div>
</template>

<script>
import { db } from '../firebase.js'
import { useFirebaseAuth } from 'vuefire'
import { signInWithPopup, GoogleAuthProvider } from 'firebase/auth'
import { ref as dbRef, set } from 'firebase/database'

const auth = useFirebaseAuth()

const provider = new GoogleAuthProvider()
provider.addScope('https://www.googleapis.com/auth/userinfo.email')

export default {
  name: 'HelloWorld',
  metaInfo: {
    title: 'æ­¡è¿',
  },
  props: ['names', 'myTotal', 'myToDay', 'allnames', 'len'],
  data: () => ({
      step: 1,
      date: new Date().getFullYear() +'/'+ parseInt(1+new Date().getMonth()) +'/'+ new Date().getDate(),
      mode: 'today',
      number: 0,
      notJoin: false,
      p: '',
      msg: '',
      reason: '',
      key: '',
      edit: '',
      read: 0,
      user: '',
      name: '',
      token: '',
      uid: '',
      provider: '',
      photoURL: '',
      dismiss: false
  }),
  computed: {
    myS () {
      const ans = (this.myTotal || 0) * 100 / 100000000
      // console.log(ans)
      return ans
    }
  },
  methods: {
    par (u) {
      if (u == 'https://bestian.github.io/number/img/number.jpeg') {
        u = 'https://bestian.github.io/number/img/number.jpg'
      }
      return u
    },
    t: function (list) {
      var ans = list.filter(function(u) {
        return u.date == new Date().getFullYear() +'/'+ parseInt(1+new Date().getMonth()) +'/'+ new Date().getDate();
      });
      return ans;
    },
    s: function (list) {
      // console.log(list)
      list = list || []
      var l = list.slice().sort(function(a, b) {
        var arr1 = a.date.split('/');
        var arr2 = b.date.split('/');
        var ans = (parseInt(arr2[0]) * 36500 + parseInt(arr2[1]) * 3000 + parseInt(arr2[2]) * 100) - (parseInt(arr1[0]) * 36500 + parseInt(arr1[1]) * 3000 + parseInt(arr1[2]) * 100) + parseInt(b.time) - parseInt(a.time);
        return ans;
      })
      return l
    },
    obj_to_list (obj) {
      if (Array.isArray(obj)) {
        return [...obj]
      } else {
        const ks = Object.keys(obj)
        const list = ks.map(function (i) {
          return obj[i]
        })
        return list
      }
    },
    addNumber () {
      const vm = this
      var arr = this.obj_to_list(this.names)
      // console.log(arr)
      
      if (!this.name) {
        alert('è«‹è¼¸å…¥æ‚¨çš„å¤§å');
        return;
      }
      var o = {
        uid: this.uid || '123',
        n: this.name,
        reason: this.reason,
        photoURL: (this.photoURL && this.photoURL !== 'https://bestian.github.io/number/img/number.jpeg') ? this.photoURL : 'https://bestian.github.io/number/img/number.jpg',
        time: (new Date()).getTime(),
        date: this.date,
        notJoin: this.notJoin,
        number: this.number
      }
      if (this.number && parseInt(this.number) > 0) {
        if (this.names.filter(function (o) {
          return o.n === vm.name && o.date === vm.date
        }).length === 0) {
          const idx = arr.length
          // arr.push(o)
          // console.log(arr)
          console.log('push new data')
          set(dbRef(db, 'names/' + idx), o).then(() => {
            window.alert('ç™»å…¥æˆåŠŸ:' + o.n + 'ä»Šå¤©å¿µäº†' + o.number +  'è²ä½›è™Ÿ')
            localStorage.name = this.name;
            this.number = 0;
          })
        } else {
          window.alert('æ‚¨ä»Šå¤©å·²ç™»å…¥éï¼Œè«‹æ˜å¤©å†ä¾†')
        }
      } else {
        window.alert('è«‹è¼¸å…¥æ‚¨ä»Šå¤©å¿µäº†å¹¾è²ä½›è™Ÿ')
      }
    },
    logout () {
      const vm = this
      auth.signOut().then(function() {
        vm.user = null
        vm.uid = null
        vm.photoURL = null
      })
    },
    loginGoogle () {
      const vm = this

      /* var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.allnames.slice(0, this.allnames.length - 100)));
      var dlAnchorElem = document.getElementById('downloadAnchorElem');
      dlAnchorElem.setAttribute("href",     dataStr     );
      dlAnchorElem.setAttribute("download", "data-old.json");
      dlAnchorElem.click();


      var dataStr1 = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.allnames.slice(this.allnames.length - 100, this.allnames.length + 1)));
      var dlAnchorElem1 = document.getElementById('downloadAnchorElem1');
      dlAnchorElem1.setAttribute("href",     dataStr1     );
      dlAnchorElem1.setAttribute("download", "data-new.json");
      dlAnchorElem1.click(); */

      if (this.isInApp) {
        window.alert('æœ¬ç³»çµ±ä¸æ”¯æ´facebook, lineç­‰appå…§éƒ¨ç€è¦½ï¼Œè«‹ç”¨ä¸€èˆ¬ç€è¦½å™¨é–‹å•Ÿï¼Œæ–¹å¯ç™»å…¥ï¼Œè¬è¬')
      } else {
        signInWithPopup(auth, provider).then((result) => {
        // This gives you a Google Access Token. You can use it to access the Google API.
        const credential = GoogleAuthProvider.credentialFromResult(result)
        const token = credential.accessToken
        // The signed-in user info.
        const user = result.user
        vm.user = user
        vm.email = user.providerData[0].email
        vm.token = token
        vm.uid = user.uid
        vm.photoURL = decodeURI(user.photoURL)
      }).catch((error) => {
        // Handle Errors here.
        const errorCode = error.code;
        const errorMessage = error.message;
        // The email of the user's account used.
        // const email = error.customData.email;
        // The AuthCredential type that was used.
        // const credential = GoogleAuthProvider.credentialFromError(error);
        console.log(errorCode)
        console.log(errorMessage)
      });
      // signInWithRedirect(auth, provider)
      }
    }
  },
  mounted() {
    if (localStorage.name) {
      this.name = localStorage.name;
    }
    if (localStorage.dismiss) {
      this.dismiss = JSON.parse(localStorage.dismiss);
    }
    if (localStorage.reason) {
      this.reason = localStorage.reason;
    }
  },
  watch: {
    reason(newReason) {
      localStorage.reason = newReason;
    },
    dismiss(newDismiss) {
      localStorage.dismiss = newDismiss;
    }
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
h3 {
  margin: 40px 0 0;
}
ul {
  list-style-type: none;
  padding: 0;
}
li {
  display: inline-block;
  margin: 0 10px;
}
a {
  color: #42b983;
}

.ani {
}

.ani:hover {
  -webkit-animation-iteration-count: infinite;
  animation-iteration-count: infinite;
}


@-webkit-keyframes tada {
  0% {
    -webkit-transform: scale3d(1, 1, 1);
    transform: scale3d(1, 1, 1);
  }

  10%, 20% {
    -webkit-transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg);
    transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg);
  }

  30%, 50%, 70%, 90% {
    -webkit-transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg);
    transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg);
  }

  40%, 60%, 80% {
    -webkit-transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg);
    transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg);
  }

  100% {
    -webkit-transform: scale3d(1, 1, 1);
    transform: scale3d(1, 1, 1);
  }
}

@keyframes tada {
  0% {
    -webkit-transform: scale3d(1, 1, 1);
    -ms-transform: scale3d(1, 1, 1);
    transform: scale3d(1, 1, 1);
  }

  10%, 20% {
    -webkit-transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg);
    -ms-transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg);
    transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg);
  }

  30%, 50%, 70%, 90% {
    -webkit-transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg);
    -ms-transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg);
    transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg);
  }

  40%, 60%, 80% {
    -webkit-transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg);
    -ms-transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg);
    transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg);
  }

  100% {
    -webkit-transform: scale3d(1, 1, 1);
    -ms-transform: scale3d(1, 1, 1);
    transform: scale3d(1, 1, 1);
  }
}

.tada:hover {
  -webkit-animation: tada 4s linear 3;
  animation: tada 4s linear 3;
}

#s {
  font-size: 16px;
}

.fuo {
  width: 33vmin;
  border-radius: 15px;
  position: relative;
  top: 3.8em;
  z-index: -1;
}

#r {
  height: 2em;
  width: 2em;
  border-radius: 50%;
}

#ex {
  position: relative;
  width: 100%;
}

.vertical-list {
  list-style-type: none;
  padding: 0;
  margin: 0 auto !important;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  max-width: 360px;
  text-align: left;
}

</style>

